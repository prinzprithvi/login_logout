(function(a){var l={init:function(d){return this.each(function(){function l(){s&&clearTimeout(s);s=setTimeout(w,b.keyDelay)}function w(){var c=a.trim(f.val()).replace(/[\\]+|[\/]+/g,"").replace(/\s+/g," ");k=c;if(c.length>=b.minChars){b.beforeRetrieve&&(c=b.beforeRetrieve.call(this,c));f.addClass("loading");b.loadingText&&j.html('<li class="ds-message">'+b.loadingText+"</li>").show();g.show();if(b.remoteSource){p&&p.abort();var e={};e[b.queryParam]=c;p=a.getJSON(b.remoteSource,a.extend({},e,b.extraParams), function(a){t(a,c,!1)})}b.localSource&&t(b.localSource,c,!0)}else g.hide()}function u(c){if(0<a("li.ds-result-item:visible",g).length){var e=a("li",g),d="down"===c?e.eq(0):e.filter(":last"),j=a("li.active:first",g);0<j.length&&(d="down"===c?j.next():j.prev());e.removeClass("active");d.addClass("active");0<d.length&&b.onResultFocus.call(f,d.data());c=0<d.length?d.data()[b.selectValue]:k;f.val(c)}}function t(c,e,d){c=b.retrieveComplete.call(this,c,e,d);var l=b.seekValue.split(","),k=0,m=0;if(d||!b.localSource)j.html(""), g.hide();for(var p in c)if(c.hasOwnProperty(p)){for(var n="",h=0;h<l.length;h++)n+=void 0!==c[m][a.trim(l[h])]?c[m][a.trim(l[h])]:"";b.matchCase||(n=n.toLowerCase(),e=e.toLowerCase());var h=e.split(" "),q=!1,r;for(r in h)h.hasOwnProperty(r)&&-1!==n.search(h[r])&&(q=!0);if(!0===q){c[m]._dataSource=d?"local":"remote";c[m]._number=k;n=a('<li class="ds-result-item" id="ds-result-item-'+m+'"></li>').data(c[m]);q=a.extend({},c[m]);if(b.resultsHighlight)for(r in h)h.hasOwnProperty(r)&&(q[b.selectValue]= q[b.selectValue].replace(RegExp("(?![^&;]+;)(?!<[^<>]*)("+h[r]+")(?![^<>]*>)(?![^&;]+;)",""+(!b.matchCase?"gi":"g")+""),"<em>$1</em>"));h=b.formatList?b.formatList.call(f,q,n):n.html(q[b.selectValue]);j.append(h);k++;if(b.queryLimit&&b.queryLimit===k)break}m++}f.removeClass("loading");0>=k&&b.emptyText&&j.html('<li class="ds-message">'+b.emptyText+"</li>");g.show();b.resultsComplete.call(this)}var b=a.extend({},a.fn.doubleSuggest.defaultOptions,d),f=a(this).addClass("ds-input"),v=f.attr("id"),x=a('<div class="ds-container" id="ds-container-'+ v+'"></div>');f.wrap(x);var g=a('<div class="ds-results" id="ds-results-'+v+'"></div>').hide();f.after(g);var j=a('<ul class="ds-list"></ul>').css("width",f.outerWidth()).appendTo(g),k=a.trim(f.val()),s=null,p=null;f.on({"focus.doubleSuggest":function(){""!==a.trim(f.val())&&g.show()},"keydown.doubleSuggest":function(c){var e=c.keyCode;switch(e){case 38:case 40:c.preventDefault();38===e?u("up"):u("down");break;case 8:1===f.val().length&&g.hide();l();break;case 9:case 13:e=a.trim(f.val());""!==e&& e.length>=b.minChars&&(0<a("li.ds-result-item:visible",g).length&&0<a("li.active:first",j).length)&&(a("li.active:first",j).trigger("select"),c.preventDefault());break;case 27:p&&p.abort();g.hide();break;default:46===e||9<e&&32>e?g.hide():l()}},"blur.doubleSuggest":function(){g.is(":hover")||(f.val(k),g.hide())},"refresh.doubleSuggest":function(){l()},"setValue.doubleSuggest":function(a,b){k=b;f.val(b)},"updateOptions.doubleSuggest":function(c,e){b=a.extend(a.fn.doubleSuggest.defaultOptions,d,e)}, "destroy.doubleSuggest":function(){g.remove();f.val("").removeClass("ds-input").unbind(".doubleSuggest").unwrap()}});g.on({click:function(){a(this).trigger("select")},mouseover:function(){a("li",j).removeClass("active");a(this).addClass("active");b.onResultFocus.call(f,a(this).data())},select:function(){var c=a(this),d=c.data();k=d[b.selectValue];f.val(k);b.onSelect.call(f,d,c);j.html("");g.hide()}},".ds-result-item")})},refresh:function(){return this.each(function(){a(this).trigger("refresh")})}, setValue:function(d){return this.each(function(){a(this).trigger("setValue",d)})},update:function(d){return this.each(function(){a(this).trigger("updateOptions",d)})},destroy:function(){return this.each(function(){a(this).trigger("destroy")})}};a.fn.doubleSuggest=function(d){if(l[d])return l[d].apply(this,Array.prototype.slice.call(arguments,1));if("object"===typeof d||!d)return l.init.apply(this,arguments);a.error("Invalid arguments "+d+" on jQuery.doubleSuggest")};a.fn.doubleSuggest.defaultOptions= {localSource:!1,remoteSource:!1,emptyText:!1,loadingText:"Loading...",newItem:!1,selectValue:"name",seekValue:"name",queryParam:"q",queryLimit:!1,extraParams:{},matchCase:!1,minChars:1,keyDelay:500,resultsHighlight:!0,onSelect:function(){},onResultFocus:function(){},formatList:!1,beforeRetrieve:function(a){return a},retrieveComplete:function(a){return a},resultsComplete:function(){}}})(jQuery);
